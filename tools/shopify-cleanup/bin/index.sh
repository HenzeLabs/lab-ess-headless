#!/bin/bash

set -e

TRASH_DIR=".trash/shopify-cleanup"
QUERY_FILE="src/lib/queries.ts"
FORCE_MODE=false

if [[ "$1" == "--force" ]]; then
  FORCE_MODE=true
fi

mkdir -p "$TRASH_DIR"

echo ""
echo "üöÄ  Shopify Legacy Cleanup Utility"
echo "----------------------------------"
echo "üßº  Moving deleted files to: $TRASH_DIR"
echo ""

# Aggressive unused file cleanup (auto-generated by knip and Copilot)
FILES_TO_DELETE=(
  "src/components/Bestsellers.tsx"
  "src/components/BrandValues.tsx"
  "src/components/StickyHeader.tsx"
  "src/components/CustomerReviews.tsx"
  "src/components/FAQ.tsx"
  "src/components/AxeA11yScript.tsx"
  "src/components/AxeA11yScriptClient.tsx"
  "src/components/Hero.tsx"
  "src/components/Icons.tsx"
  "src/components/CollectionFilters.tsx"
  "src/app/page.tsx"
  "src/app/loading.tsx"
  "src/components/AnnouncementBar.tsx"
  "src/components/PersonaEmphasisBlock.tsx"
  "src/components/PersonaGate.tsx"
  "src/components/PersonaHero.tsx"
  "src/data/products.ts"
  "src/lib/usePersona.ts"
  "lighthouse.config.js"
  "mock/products.ts"
  "src/app/collections/[handle]/head.tsx"
  "src/app/HomeClient.tsx"
  "src/app/products/[handle]/head.tsx"
  "src/lib/collectionProductsQuery.ts"
  "src/lib/getShopifyLogoServer.ts"
  "src/lib/queries.d.ts"
)

DELETED_COUNT=0
SKIPPED_COUNT=0

for FILE in "${FILES_TO_DELETE[@]}"; do
  if [ -f "$FILE" ]; then
    if [ "$FORCE_MODE" = false ]; then
      read -p "‚ùì Delete $FILE? [y/N]: " CONFIRM
      CONFIRM=${CONFIRM,,}
      if [[ "$CONFIRM" != "y" ]]; then
        echo "‚è≠Ô∏è  Skipped: $FILE"
        ((SKIPPED_COUNT++))
        continue
      fi
    fi

    DEST="$TRASH_DIR/$(basename "$FILE")"
    mv "$FILE" "$DEST"
    echo "üóëÔ∏è  Moved: $FILE ‚Üí $DEST"
    ((DELETED_COUNT++))
  else
    echo "‚ö†Ô∏è  Not found: $FILE"
    ((SKIPPED_COUNT++))
  fi
 done

echo ""
echo "üì¶  Cleaning unused queries from $QUERY_FILE..."

if [ -f "$QUERY_FILE" ]; then
  sed -i '' '/getProductsQuery/d' "$QUERY_FILE"
  sed -i '' '/createCartMutation/d' "$QUERY_FILE"
  sed -i '' '/getCollectionByHandleQuery/d' "$QUERY_FILE"
  echo "‚úÖ  Queries cleaned."
else
  echo "‚ùå  $QUERY_FILE not found, skipping query cleanup."
fi

echo ""
echo "‚úÖ  Cleanup Summary:"
echo "   - Files moved to trash: $DELETED_COUNT"
echo "   - Files skipped/not found: $SKIPPED_COUNT"
echo ""
echo "üìç  Next Steps:"
echo "   - Review moved files in: $TRASH_DIR"
echo "   - Run: npm run build"
echo "   - Run: npx knip"
echo ""
echo "üß†  Tip: Run with --force to skip prompts"
echo "      shopify-cleanup --force"
echo "----------------------------------"
